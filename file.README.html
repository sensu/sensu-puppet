<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: README
  
    &mdash; Documentation by YARD 0.9.28
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="puppet_class_list_link"
        href="puppet_class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1 id="sensu-puppet">Sensu-Puppet</h1>

<h4 id="table-of-contents">Table of Contents</h4>

<ol>
<li><a href="#module-description">Module Description</a>

<ul>
<li><a href="#updating-this-module-from-4x-to-5x">Updating this module from 4.x to 5.x</a></li>
<li><a href="#updating-this-module-from-3x-to-4x">Updating this module from 3.x to 4.x</a></li>
</ul></li>
<li><a href="#setup">Setup - The basics of getting started with Sensu</a>

<ul>
<li><a href="#what-sensu-affects">What sensu affects</a></li>
<li><a href="#setup-requirements">Setup requirements</a></li>
<li><a href="#beginning-with-sensu">Beginning with Sensu</a></li>
</ul></li>
<li><a href="#usage">Usage - Configuration options and additional functionality</a>

<ul>
<li><a href="#location-of-resources">Location of Resources</a></li>
<li><a href="#basic-sensu-backend">Basic Sensu backend</a></li>
<li><a href="#basic-sensu-agent">Basic Sensu agent</a></li>
<li><a href="#basic-sensu-cli">Basic Sensu CLI</a></li>
<li><a href="#api-providers">API Providers</a></li>
<li><a href="#manage-windows-agent">Manage Windows Agent</a></li>
<li><a href="#advanced-agent">Advanced agent</a></li>
<li><a href="#advanced-agent---subscriptions">Advanced agent - Subscriptions</a></li>
<li><a href="#advanced-agent---annotations-and-labels">Advanced agent - Annotations and Labels</a></li>
<li><a href="#advanced-agent---custom-config-entries">Advanced agent - Custom config entries</a></li>
<li><a href="#advanced-ssl">Advanced SSL</a></li>
<li><a href="#enterprise-support">Enterprise support</a></li>
<li><a href="#contact-routing">Contact routing</a></li>
<li><a href="#postgresql-datastore-support">PostgreSQL datastore support</a></li>
<li><a href="#installing-plugins">Installing Plugins</a></li>
<li><a href="#installing-extensions">Installing Extensions</a></li>
<li><a href="#exported-resources">Exported resources</a></li>
<li><a href="#hiera-resources">Hiera resources</a></li>
<li><a href="#resource-purging">Resource purging</a></li>
<li><a href="#sensu-backend-cluster">Sensu backend cluster</a>

<ul>
<li><a href="#adding-backend-members-to-an-existing-cluster">Adding backend members to an existing cluster</a></li>
</ul></li>
<li><a href="#sensu-backend-federation">Sensu backend federation</a></li>
<li><a href="#large-environment-considerations">Large Environment Considerations</a></li>
<li><a href="#composite-names-for-namespaces">Composite Names for Namespaces</a></li>
<li><a href="#installing-bonsai-assets">Installing Bonsai Assets</a></li>
<li><a href="#bolt-tasks">Bolt Tasks</a></li>
</ul></li>
<li><a href="#reference">Reference</a>

<ul>
<li><a href="#facts">Facts</a></li>
</ul></li>
<li><a href="#examples">Examples</a></li>
<li><a href="#limitations">Limitations - OS compatibility, etc.</a></li>
<li><a href="#development">Development - Guide for contributing to the module</a></li>
<li><a href="#license">License</a></li>
</ol>

<h2 id="module-description">Module description</h2>

<p>Installs and manages <a href="https://sensu.io/">Sensu Go</a>, the open source monitoring framework.</p>

<p>Please note, that this is a <strong>Partner Supported</strong> module, which means that technical customer support for this module is solely provided by Sensu. Puppet does not provide support for any <strong>Partner Supported</strong> modules. Technical support for this module is provided by Sensu at <a href="https://sensu.io/support">https://sensu.io/support</a>.</p>

<h3 id="documented-with-puppet-strings">Documented with Puppet Strings</h3>

<p><a href="http://sensu.github.io/sensu-puppet/">Puppet Strings documentation</a></p>

<h3 id="compatibility-supported-sensu-versions">Compatibility - supported Sensu versions</h3>

<p>If not explicitly stated it should always support the latest Sensu release.
Beginning with v5.0.0 this module will only support Sensu Go 6.0+.
Please log an issue if you identify any incompatibilities.</p>

<table><thead>
<tr>
<th>Sensu Go Version</th>
<th>Recommended Puppet Module Version</th>
</tr>
</thead><tbody>
<tr>
<td>5.0 - 5.15</td>
<td>latest v3</td>
</tr>
<tr>
<td>5.16+</td>
<td>latest v4</td>
</tr>
<tr>
<td>6.0</td>
<td>v5.0.0</td>
</tr>
<tr>
<td>6.1+</td>
<td>v5.1.0+</td>
</tr>
</tbody></table>

<h3 id="upgrade-note">Upgrade note</h3>

<p>Sensu Go 5.x is a rewrite of Sensu and no longer depends on redis and rabbitmq.
Version 3 of this module supports Sensu Go &gt;= 5.0.0 to &lt; 5.16.0.
Version 4 of this module supports Sensu Go &gt;= 5.16.0 &lt; 6.0.0.
Version 5.0.0 of this module supports Sensu Go &gt;= 6.0.0 &lt; 6.1.0.
Version 5.1.0+ of this module supports Sensu Go &gt;= 6.1.0 &lt; 7.0.0.</p>

<p>Users wishing to use the previous Ruby based Sensu should use the <a href="https://forge.puppet.com/sensu/sensuclassic">sensu/sensuclassic</a> module.</p>

<h3 id="updating-this-module-from-4-x-to-5-x">Updating this module from 4.x to 5.x</h3>

<p>This module begins supporting Sensu Go 6 with version &gt;= 5.0.0</p>

<p><strong>NOTE</strong> Upgrading to support Sensu Go 6 requires backends have Puppet applied before agents will begin to work as there is an agent specifc Sensu user and role added to support modifying agent entities via the API.</p>

<p>Class parameter changes:</p>

<ul>
<li>Remove deprecated <code>sensu::old_password</code> and <code>sensu::old_agent_password</code>, these parameters are no longer needed and were removed</li>
</ul>

<p>Type property changes:</p>

<ul>
<li>Remove deprecated <code>url</code>, <code>sha512</code> and <code>filters</code> properties from <code>sensu_asset</code>, use <code>builds</code> property instead</li>
</ul>

<h4 id="changes-for-backend">Changes for backend</h4>

<p>There is a manual step to perform to upgrade the sensu-backend after upgrading the backend to 6.x.
This module provides the <code>sensu::backend_upgrade</code> bolt task as a way to execute the necessary <code>sensu-backend upgrade</code> command.</p>

<h4 id="changes-for-agents">Changes for agents</h4>

<p>Beginning with Sensu Go 6, some changes to <code>agent.yml</code> will only bootstrap an agent entity, they will not update the entity.
If you wish to make changes to values such as <code>subscriptions</code>, <code>labels</code> or <code>annotations</code> after a host is added to Sensu this must be done
via the Sensu Go API. To support this it&#39;s now required that agents have the ability to make API calls.</p>

<p>In order to ensure agents can make API calls either via API or sensuctl the agent must be told about the admin password and API host:</p>

<pre class="code ruby"><code class="ruby">class { &#39;sensu&#39;:
  api_host                     =&gt; &#39;sensu-backend.example.com&#39;,
  agent_entity_config_password =&gt; &#39;supersecret&#39;,
}
class { &#39;sensu::agent&#39;:
  ...
}
</code></pre>

<p>See <a href="#api-providers">API Providers</a> for example Hiera that can be used in a file like <code>common.yaml</code> to easily share the admin password with agents.</p>

<p>This module will still continue to write subscriptions and other agent configurations to <code>agent.yml</code> so that if an agent entity is deleted it can be recreated
by restarting the <code>sensu-agent</code> service.</p>

<p>Beginning with Sensu Go 6.2.0 you can go back to making <code>agent.yml</code> the authoritative source for an agent&#39;s config by setting <code>sensu::agent::agent_managed_entity</code> to <code>true</code>.</p>

<h3 id="updating-this-module-from-3-x-to-4-x">Updating this module from 3.x to 4.x</h3>

<p>Class parameter changes:</p>

<ul>
<li>Move <code>sensu::backend::cli_package_name</code> to <code>sensu::cli::package_name</code></li>
<li>Move <code>sensu::backend::sensuctl_chunk_size</code> to <code>sensu::cli::sensuctl_chunk_size</code></li>
<li>Move <code>sensu::backend::url_host</code> to <code>sensu::api_host</code></li>
<li>Move <code>sensu::backend::url_port</code> to <code>sensu::api_port</code></li>
<li>Move <code>sensu::backend::password</code> to <code>sensu::password</code></li>
<li>Move <code>sensu::backend::old_password</code> to <code>sensu::old_password</code></li>
<li>Move <code>sensu::backend::agent_password</code> to <code>sensu::agent_password</code></li>
<li>Move <code>sensu::backend::agent_old_password</code> to <code>sensu::agent_old_password</code></li>
<li>The following parameters were moved from <code>sensu::backend</code> class to <code>sensu::resources</code> class. (<strong>Example:</strong> <code>sensu::backend::checks</code> becomes <code>sensu::resources::checks</code>)

<ul>
<li><code>ad_auths</code></li>
<li><code>assets</code></li>
<li><code>bonsai_assets</code></li>
<li><code>checks</code></li>
<li><code>cluster_members</code></li>
<li><code>cluster_role_bindings</code></li>
<li><code>cluster_roles</code></li>
<li><code>configs</code> (removed)</li>
<li><code>entities</code></li>
<li><code>etcd_replicators</code></li>
<li><code>filters</code></li>
<li><code>handlers</code></li>
<li><code>hooks</code></li>
<li><code>ldap_auths</code></li>
<li><code>mutators</code></li>
<li><code>namespaces</code></li>
<li><code>oidc_auths</code></li>
<li><code>role_bindings</code></li>
<li><code>roles</code></li>
<li><code>users</code></li>
</ul></li>
</ul>

<p>Type property changes:</p>

<ul>
<li>Replace <code>sensu_check</code> <code>proxy_requests*</code> properties with <code>proxy_requests</code> Hash</li>
<li>Replace <code>sensu_entity</code> <code>deregistration_handler</code> with <code>deregistration</code> Hash</li>
<li>Replace <code>sensu_handler</code> <code>socket_*</code> properties with <code>socket</code> Hash</li>
<li>Refactor <code>sensu_ldap_auth</code> and <code>sensu_ad_auth</code> on how properties are defined.

<ul>
<li>Move <code>server_binding</code>, <code>server_group_search</code> and <code>server_user_search</code> into <code>servers</code> property</li>
</ul></li>
</ul>

<p>Breaking changes:</p>

<ul>
<li>Remove <code>sensu_event</code> type, replaced with <code>sensu::event</code> Bolt task</li>
<li>Remove <code>sensu_silenced</code> type, replaced with <code>sensu::silenced</code> Bolt task</li>
<li>Remove <code>sensu_config</code> type, replaced with <code>sensu::cli::config_format</code> and <code>sensu::cli::config_namespace</code> parameters</li>
</ul>

<h2 id="setup">Setup</h2>

<h3 id="what-sensu-affects">What sensu affects</h3>

<p>This module will install packages, create configuration and start services necessary to manage Sensu agents and backend.</p>

<h3 id="setup-requirements">Setup requirements</h3>

<p>Plugin sync is required if the custom sensu types and providers are used.</p>

<h4 id="soft-module-dependencies">Soft module dependencies</h4>

<p>For systems using <code>apt</code>:</p>

<ul>
<li><a href="https://forge.puppet.com/puppetlabs/apt">puppetlabs/apt</a> module (<code>&gt;= 5.0.1 &lt; 9.0.0</code>)</li>
</ul>

<p>For systems using <code>yum</code> and Puppet &gt;= 6.0.0:</p>

<ul>
<li><a href="https://forge.puppet.com/puppetlabs/yumrepo_core">puppetlabs/yumrepo_core</a> module (<code>&gt;= 1.0.1 &lt; 2.0.0</code>)</li>
</ul>

<p>For Windows:</p>

<ul>
<li><a href="https://forge.puppet.com/puppetlabs/chocolatey">puppetlabs/chocolatey</a> module (<code>&gt;= 3.0.0 &lt; 7.0.0</code>)</li>
<li><a href="https://forge.puppet.com/puppet/windows_env">puppet/windows_env</a> module (<code>&gt;= 3.0.0 &lt; 5.0.0</code>)</li>
<li><a href="https://forge.puppet.com/puppet/archive">puppet/archive</a> module (<code>&gt;= 3.0.0 &lt; 5.0.0</code>)</li>
</ul>

<h3 id="beginning-with-sensu">Beginning with Sensu</h3>

<p>This module provides Vagrant definitions that can be used to get started with Sensu.</p>

<pre class="code bash"><code class="bash">vagrant up sensu-backend
vagrant ssh sensu-backend
</code></pre>

<h4 id="beginning-with-a-sensu-cluster">Beginning with a Sensu cluster</h4>

<p>Multiple Vagrant boxes are available for testing a sensu-backend cluster.</p>

<pre class="code bash"><code class="bash">vagrant up sensu-backend-peer1 sensu-backend-peer2
vagrant provision sensu-backend-peer1 sensu-backend-peer2
</code></pre>

<h4 id="beginning-with-a-sensu-federated-cluster">Beginning with a Sensu federated cluster</h4>

<p>Multiple Vagrant boxes are available for testing a Sensu Go federated cluster.
First build and provision both then provision the first a second time to view that the custom role was replicated.</p>

<pre class="code base"><code class="base">vagrant up sensu-backend-federated1 sensu-backend-federated2
vagrant provision sensu-backend-federated1
</code></pre>

<p>The <code>provision</code> command should output from <code>sensuctl</code> the <code>test</code> Sensu Go Role that was created on the other backend.
The output should look like the following:</p>

<pre class="code ruby"><code class="ruby">    sensu-backend-federated1:   Name   Namespace   Rules  
    sensu-backend-federated1:  ────── ─────────── ─────── 
    sensu-backend-federated1:   test   default         1  
</code></pre>

<h2 id="usage">Usage</h2>

<h3 id="location-of-resources">Location of Resources</h3>

<p>Sensu Go is designed to have resources like checks and assets defined on the backend host.
For Puppet this means that the simplest configuration will be one where checks and other resources are defined on the host using <code>sensu::backend</code> class.
Hosts with only the <code>sensu::agent</code> class do not need to have checks defined on them, rather just have to have a subscription assigned that matches a check.</p>

<h3 id="basic-sensu-backend">Basic Sensu backend</h3>

<p>The following example will configure sensu-backend, sensu-agent on backend and add a check.
By default this module will configure the backend to use Puppet&#39;s SSL certificate and CA.
It is advisable to not rely on the default password.
<strong>NOTE</strong> When changing the password value, it&#39;s necessary to run Puppet on the backend first to update the <code>admin</code> password.</p>

<pre class="code puppet"><code class="puppet">  class { &#39;sensu&#39;:
    password =&gt; &#39;supersecret&#39;,
  }
  include sensu::backend
  include sensu::agent
  sensu_check { &#39;check-cpu&#39;:
    ensure        =&gt; &#39;present&#39;,
    command       =&gt; &#39;check-cpu.sh -w 75 -c 90&#39;,
    interval      =&gt; 60,
    subscriptions =&gt; [&#39;linux&#39;],
  }
</code></pre>

<h3 id="basic-sensu-agent">Basic Sensu agent</h3>

<p>The following example will manage resources necessary to configure a sensu-agent to communicate with a sensu-backend and
associated to <code>linux</code> and <code>apache-servers</code> subscriptions.</p>

<pre class="code puppet"><code class="puppet">  class { &#39;sensu&#39;:
    api_host                     =&gt; &#39;sensu-backend.example.com&#39;,
    agent_entity_config_password =&gt; &#39;supersecret&#39;,
  }
  class { &#39;sensu::agent&#39;:
    backends      =&gt; [&#39;sensu-backend.example.com:8081&#39;],
    subscriptions =&gt; [&#39;linux&#39;, &#39;apache-servers&#39;],
  }
</code></pre>

<h3 id="basic-sensu-cli">Basic Sensu CLI</h3>

<p>The following example will manage the resources necessary to use <code>sensuctl</code>.</p>

<pre class="code puppet"><code class="puppet">class { &#39;sensu&#39;:
  api_host =&gt; &#39;sensu-backend.example.com&#39;,
  password =&gt; &#39;supersecret&#39;,
}
include sensu::cli
</code></pre>

<p><strong>NOTE</strong>: The <code>sensu::backend</code> class calls the <code>sensu::cli</code> class so it is only necessary to directly call the <code>sensu::cli</code> class on hosts not using the <code>sensu::backend</code> class.</p>

<p>For Windows the <code>install_source</code> parameter must be provided:</p>

<pre class="code puppet"><code class="puppet">class { &#39;sensu&#39;:
  api_host =&gt; &#39;sensu-backend.example.com&#39;,
  password =&gt; &#39;supersecret&#39;,
}
class { &#39;sensu::cli&#39;:
  install_source =&gt; &#39;https://s3-us-west-2.amazonaws.com/sensu.io/sensu-go/5.14.1/sensu-go_5.14.1_windows_amd64.zip&#39;,
}
</code></pre>

<h3 id="api-providers">API Providers</h3>

<p>All the core resources have a provider that manages resources using the Sensu Go API.
The new provider can be used by setting <code>provider</code> parameter on a resource to <code>sensu_api</code>.
The default provider is still <code>sensuctl</code> but it&#39;s possible to change the provider when defining a resource.
For example the following will create a check which can be defined on an host that&#39;s not the <code>sensu-backend</code>.</p>

<pre class="code ruby"><code class="ruby">include ::sensu::api
sensu_check { &quot;check-cpu-${facts[&#39;hostname&#39;]}&quot;:
  ensure        =&gt; &#39;present&#39;,
  command       =&gt; &#39;check-cpu.sh -w 75 -c 90&#39;,
  interval      =&gt; 60,
  subscriptions =&gt; [&quot;entity:${facts[&#39;hostname&#39;]}&quot;],
  provider      =&gt; &#39;sensu_api&#39;,
}
</code></pre>

<p>The <code>sensu::api</code> class is required in order to configure the credentials and URL used to communicate with the Sensu backend API.</p>

<p>The API URL, username and password used for the API are set in the <code>sensu</code> class and can be set easily with Hiera:</p>

<pre class="code yaml"><code class="yaml">sensu::api_host: sensu-backend.example.com
sensu::api_port: 8080
sensu::username: admin
sensu::password: supersecret
sensu::agent_entity_config_password: supersecret
</code></pre>

<h3 id="manage-windows-agent">Manage Windows Agent</h3>

<p>This module supports Windows Sensu Go agent via chocolatey beginning with version 5.12.0.</p>

<pre class="code puppet"><code class="puppet">class { &#39;sensu&#39;:
  api_host                     =&gt; &#39;sensu-backend.example.com&#39;,
  agent_entity_config_password =&gt; &#39;supersecret&#39;,
}
class { &#39;sensu::agent&#39;:
  backends      =&gt; [&#39;sensu-backend.example.com:8081&#39;],
  subscriptions =&gt; [&#39;windows&#39;],
}
</code></pre>

<p>If you do not wish to install using chocolatey then you must define <code>package_source</code> as either a URL, a Puppet source or a filesystem path.</p>

<p>Install sensu-go-agent on Windows from URL:</p>

<pre class="code puppet"><code class="puppet">class { &#39;sensu::agent&#39;:
  package_name   =&gt; &#39;Sensu Agent&#39;,
  package_source =&gt; &#39;https://s3-us-west-2.amazonaws.com/sensu.io/sensu-go/5.13.1/sensu-go-agent_5.13.1.5957_en-US.x64.msi&#39;,
}
</code></pre>

<p>Install sensu-go-agent on Windows from Puppet source:</p>

<pre class="code puppet"><code class="puppet">class { &#39;sensu::agent&#39;:
  package_name   =&gt; &#39;Sensu Agent&#39;,
  package_source =&gt; &#39;puppet:///modules/profile/sensu/sensu-go-agent.msi&#39;,
}
</code></pre>

<p>If a system already has the necessary MSI present it can be installed without downloading from an URL:</p>

<pre class="code puppet"><code class="puppet">class { &#39;sensu::agent&#39;:
  package_name   =&gt; &#39;Sensu Agent&#39;,
  package_source =&gt; &#39;C:\Temp\sensu-go-agent.msi&#39;,
}
</code></pre>

<h3 id="advanced-agent">Advanced agent</h3>

<p>If you wish to have the <code>agent.yml</code> be authoritative for agent entity configs:</p>

<pre class="code puppet"><code class="puppet">class { &#39;sensu::agent&#39;:
  agent_managed_entity  =&gt; true,
}
</code></pre>

<p>If you wish to change the <code>agent</code> password you must provide the new and old password.
It is advisable to set <code>show_diff</code> to <code>false</code> to avoid exposing the agent password.</p>

<pre class="code puppet"><code class="puppet">class { &#39;sensu&#39;:
  agent_password =&gt; &#39;supersecret&#39;,
}
class { &#39;sensu::agent&#39;:
  show_diff =&gt; false,
}
</code></pre>

<p>The <code>config_hash</code> parameter allows custom configuration for <code>agent.yml</code> outside the <code>sensu::agent</code> class parameters.</p>

<pre class="code puppet"><code class="puppet">class { &#39;sensu::agent&#39;:
  config_hash =&gt; {
    &#39;log-level&#39; =&gt; &#39;debug&#39;,
  },
}
</code></pre>

<p>The following parameters in <code>sensu::agent</code> class are used to populate <code>agent.yml</code>:</p>

<ul>
<li>entity_name - Passed to <code>name</code> key in <code>agent.yml</code></li>
<li>subscriptions</li>
<li>annotations</li>
<li>labels</li>
<li>namespace</li>
<li>redact</li>
</ul>

<p>Agent configurations can also be set via <code>sensu::agent::config_entry</code>. See <a href="#advanced-agent---custom-config-entries">Advanced agent - Custom config entries</a>.</p>

<h3 id="advanced-agent-subscriptions">Advanced agent - Subscriptions</h3>

<p>It is possible to define subscriptions in many locations and the values merged into <code>agent.yml</code>:</p>

<pre class="code ruby"><code class="ruby">class { &#39;sensu::agent&#39;:
  subscriptions =&gt; [&#39;base&#39;],
}
</code></pre>

<p>Then in a profile class for Apache you could define the following:</p>

<pre class="code ruby"><code class="ruby">sensu::agent::subscription { &#39;apache&#39;: }
</code></pre>

<p>The resulting <code>agent.yml</code> would contain subscriptions for both <code>base</code> and <code>apache</code>.</p>

<p><strong>NOTE</strong>: Subscriptions defined using the <code>sensu::agent</code> class and <code>sensu::agent::subscription</code> are merged to produce the final subscription array.</p>

<h3 id="advanced-agent-annotations-and-labels">Advanced agent - Annotations and Labels</h3>

<p>It is possible to define annotations and labels in many locations and the values merged into <code>agent.yml</code>:</p>

<pre class="code puppet"><code class="puppet">class { &#39;sensu::agent&#39;:
  labels      =&gt; { &#39;location&#39; =&gt; &#39;uswest&#39;, &#39;contacts&#39; =&gt; &#39;ops@example.com&#39; },
  annotations =&gt; { &#39;cpu.warning&#39; =&gt; &#39;90&#39;, &#39;cpu.critical&#39; =&gt; &#39;100&#39; },
}
</code></pre>

<p>Then in a profile class you can define the following:</p>

<pre class="code puppet"><code class="puppet">sensu::agent::label { &#39;contacts&#39;: value =&gt; &#39;devs@example.com&#39; }
sensu::agent::label { &#39;environment&#39;: value =&gt; &#39;dev&#39; }
sensu::agent::annotation { &#39;cpu.warning&#39;: value =&gt; &#39;75&#39; }
sensu::agent::annotation { &#39;fatigue_check/occurrences&#39;: value =&gt; &#39;2&#39; }
</code></pre>

<p>The resulting <code>agent.yml</code> will contain the following:</p>

<pre class="code yaml"><code class="yaml">labels:
  location: uswest
  contacts: devs@example.com
  environment: dev
annotations:
  cpu.warning: &#39;75&#39;
  cpu.critical: &#39;100&#39;
  fatigue_check/occurrences: &#39;2&#39;
</code></pre>

<p><strong>NOTE</strong> <code>sensu::agent::annotation</code> and <code>sensu::agent::label</code> take precedence over values set by the class <code>sensu::agent</code></p>

<p>If you wish to redact a label or annotation you can use the <code>redact</code> parameter and the key will be added to the <code>redact</code> list in <code>agent.yml</code>:</p>

<pre class="code puppet"><code class="puppet">sensu::agent::label { &#39;secret&#39;:
  value  =&gt; &#39;mysecret&#39;,
  redact =&gt; true,
}
sensu::agent::annotation { &#39;ec2_access_key&#39;:
  value  =&gt; &#39;some-key&#39;,
  redact =&gt; true,
}
</code></pre>

<h3 id="advanced-agent-disable-validations">Advanced agent - Disable validations</h3>

<p>In some cases it might be desired to disable API and entity validations when agents are managing their own entity.</p>

<pre class="code puppet"><code class="puppet">class { &#39;sensu&#39;:
  validate_api =&gt; false,
}
class { &#39;sensu::agent&#39;:
  agent_managed_entity =&gt; true,
  validate_entity      =&gt; false,
}
</code></pre>

<h3 id="advanced-agent-custom-config-entries">Advanced agent - Custom config entries</h3>

<p>It is possible to define config entries for <code>agent.yml</code> in many locations in Puppet:</p>

<pre class="code puppet"><code class="puppet">sensu::agent::config_entry { &#39;keepalive-interval&#39;: value =&gt; 20 }
</code></pre>

<p>This would add the following to <code>agent.yml</code>:</p>

<pre class="code yaml"><code class="yaml">keepalive-interval: 20
</code></pre>

<p><strong>NOTE</strong> <code>sensu::agent::config_entry</code> takes precendence over values defined in <code>sensu::agent</code> class.</p>

<h3 id="advanced-ssl">Advanced SSL</h3>

<p>By default this module uses Puppet&#39;s SSL certificates and CA.
If you would prefer to use different certificates override the <code>ssl_ca_source</code>, <code>ssl_cert_source</code> and <code>ssl_key_source</code> parameters.
The value for <code>api_host</code> must be valid for the provided certificate and the value used for agent&#39;s <code>backends</code> must also match the certificate used by the specified backend.
If the certificates and keys are already installed then define the source parameters as filesystem paths.</p>

<pre class="code puppet"><code class="puppet">class { &#39;sensu&#39;:
  ssl_ca_source =&gt; &#39;puppet:///modules/profile/sensu/ca.pem&#39;,
  api_host      =&gt; &#39;sensu-backend.example.com&#39;,
}
class { &#39;sensu::backend&#39;:
  ssl_cert_source =&gt; &#39;puppet:///modules/profile/sensu/cert.pem&#39;,
  ssl_key_source  =&gt; &#39;puppet:///modules/profile/sensu/key.pem&#39;,
}
</code></pre>

<pre class="code puppet"><code class="puppet">class { &#39;sensu&#39;:
  ssl_ca_source =&gt; &#39;puppet:///modules/profile/sensu/ca.pem&#39;,
}
class { &#39;sensu::agent&#39;:
  backends      =&gt; [&#39;sensu-backend.example.com:8081&#39;],
  subscriptions =&gt; [&#39;linux&#39;, &#39;apache-servers&#39;],
}
</code></pre>

<p>To disable SSL support:</p>

<pre class="code puppet"><code class="puppet">class { &#39;sensu&#39;:
  use_ssl =&gt; false,
}
</code></pre>

<h3 id="enterprise-support">Enterprise Support</h3>

<p>In order to activate enterprise support the license file needs to be added:</p>

<pre class="code puppet"><code class="puppet">class { &#39;sensu::backend&#39;:
  license_source =&gt; &#39;puppet:///modules/profile/sensu/license.json&#39;,
}
</code></pre>

<p>The types <code>sensu_ad_auth</code> and <code>sensu_ldap_auth</code> require a valid enterprise license.</p>

<h3 id="contact-routing">Contact routing</h3>

<p>See <a href="https://docs.sensu.io/sensu-go/latest/observability-pipeline/observe-filter/route-alerts/">Sensu Go - Route alerts with event filters</a> for details. The following is one way to configure contact routing in Puppet.</p>

<p>Add the sensu-go-has-contact-filter bonsai asset:</p>

<pre class="code puppet"><code class="puppet">sensu_bonsai_asset { &#39;sensu/sensu-go-has-contact-filter&#39;:
  ensure  =&gt; &#39;present&#39;,
  version =&gt; &#39;0.2.0&#39;,
}
</code></pre>

<p>Add the filters for the defined contacts</p>

<pre class="code puppet"><code class="puppet">sensu_filter { &#39;contact_dev&#39;:
  ensure         =&gt; &#39;present&#39;,
  action         =&gt; &#39;allow&#39;,
  runtime_assets =&gt; [&#39;sensu/sensu-go-has-contact-filter&#39;],
  expressions    =&gt; [&#39;has_contact(event, &quot;dev&quot;)&#39;],
}
sensu_filter { &#39;contact_ops&#39;:
  ensure         =&gt; &#39;present&#39;,
  action         =&gt; &#39;allow&#39;,
  runtime_assets =&gt; [&#39;sensu/sensu-go-has-contact-filter&#39;],
  expressions    =&gt; [&#39;has_contact(event, &quot;ops&quot;)&#39;],
}
</code></pre>

<p>Add the handlers asset and  handlers for each contact</p>

<pre class="code puppet"><code class="puppet">sensu_bonsai_asset { &#39;sensu/sensu-email-handler&#39;:
  ensure  =&gt; &#39;present&#39;,
  version =&gt; &#39;0.2.0&#39;,
}
sensu_handler { &#39;email_dev&#39;:
  ensure          =&gt; &#39;present&#39;,
  type            =&gt; &#39;pipe&#39;,
  command         =&gt; &#39;sensu-email-handler -f root@localhost -t dev@example.com -s localhost -i&#39;,
  timeout         =&gt; 10,
  runtime_assets  =&gt; [&#39;sensu/sensu-email-handler&#39;],
  filters         =&gt; [&#39;is_incident&#39;,&#39;not_silenced&#39;,&#39;contact_dev&#39;],
}
sensu_handler { &#39;email_ops&#39;:
  ensure          =&gt; &#39;present&#39;,
  type            =&gt; &#39;pipe&#39;,
  command         =&gt; &#39;sensu-email-handler -f root@localhost -t ops@example.com -s localhost -i&#39;,
  timeout         =&gt; 10,
  runtime_assets  =&gt; [&#39;sensu/sensu-email-handler&#39;],
  filters         =&gt; [&#39;is_incident&#39;,&#39;not_silenced&#39;,&#39;contact_ops&#39;],
}
</code></pre>

<p>Create a handler set to centralize handler management for emails</p>

<pre class="code puppet"><code class="puppet">sensu_handler { &#39;email&#39;:
  ensure    =&gt; &#39;present&#39;,
  type      =&gt; &#39;set&#39;,
  handlers  =&gt; [&#39;email_dev&#39;,&#39;email_ops&#39;],
}
</code></pre>

<p>Lastly define a service that use the contact and the email handler:</p>

<pre class="code puppet"><code class="puppet">sensu_check { &#39;check_cpu&#39;:
  ensure         =&gt; &#39;present&#39;,
  labels         =&gt; {
    &#39;contacts&#39; =&gt; &#39;dev, ops&#39;,
  },
  command        =&gt; &#39;check-cpu.rb -w 75 -c 90&#39;,
  handlers       =&gt; [&#39;email&#39;],
  interval       =&gt; 30,
  publish        =&gt; true,
  subscriptions  =&gt; [&#39;linux&#39;],
  runtime_assets =&gt; [&#39;sensu-plugins-cpu-checks&#39;,&#39;sensu-ruby-runtime&#39;],
}
</code></pre>

<p>Agents can also have contacts defined:</p>

<pre class="code puppet"><code class="puppet">class { &#39;sensu::agent&#39;:
  labels =&gt; {
    &#39;contacts&#39; =&gt; &#39;dev, ops&#39;,
  },
}
</code></pre>

<h3 id="postgresql-datastore-support">PostgreSQL datastore support</h3>

<p><strong>NOTE</strong>: This features require a valid Sensu Go enterprise license.</p>

<p>The following example will add a PostgreSQL server and database to the sensu-backend host and configure Sensu Go to use PostgreSQL as the event datastore.</p>

<pre class="code puppet"><code class="puppet">class { &#39;postgresql::globals&#39;:
  manage_package_repo =&gt; true,
  version             =&gt; &#39;11&#39;,
}
class { &#39;postgresql::server&#39;: }
class { &#39;sensu::backend&#39;:
  license_source      =&gt; &#39;puppet:///modules/profile/sensu/license.json&#39;,
  datastore           =&gt; &#39;postgresql&#39;,
  postgresql_password =&gt; &#39;secret&#39;,
}
</code></pre>

<p>Refer to the <a href="https://forge.puppet.com/puppetlabs/postgresql">puppetlabs/postgresql</a> module documentation for details on how to manage PostgreSQL with Puppet.</p>

<p>The following example uses an external PostgreSQL server.</p>

<pre class="code puppet"><code class="puppet">class { &#39;sensu::backend&#39;:
  license_source       =&gt; &#39;puppet:///modules/profile/sensu/license.json&#39;,
  datastore            =&gt; &#39;postgresql&#39;,
  postgresql_password  =&gt; &#39;secret&#39;,
  postgresql_host      =&gt; &#39;postgresql.example.com&#39;,
  manage_postgresql_db =&gt; false,
}
</code></pre>

<h3 id="installing-plugins">Installing Plugins</h3>

<p>Plugin management is handled by the <code>sensu::plugins</code> class.</p>

<p>Example installing plugins on agent:</p>

<pre class="code puppet"><code class="puppet">  class { &#39;sensu::agent&#39;:
    backends      =&gt; [&#39;sensu-backend.example.com:8081&#39;],
    subscriptions =&gt; [&#39;linux&#39;, &#39;apache-servers&#39;],
  }
  class { &#39;sensu::plugins&#39;:
    plugins =&gt; [&#39;disk-checks&#39;],
  }
</code></pre>

<p>The <code>plugins</code> parameter can also be a Hash that sets the version:</p>

<pre class="code puppet"><code class="puppet">  class { &#39;sensu::agent&#39;:
    backends      =&gt; [&#39;sensu-backend.example.com:8081&#39;],
    subscriptions =&gt; [&#39;linux&#39;, &#39;apache-servers&#39;],
  }
  class { &#39;sensu::plugins&#39;:
    plugins =&gt; {
      &#39;disk-checks&#39; =&gt; { &#39;version&#39; =&gt; &#39;latest&#39; },
    },
  }
</code></pre>

<p>Set <code>dependencies</code> to an empty Array to disable the <code>sensu::plugins</code> dependency management.</p>

<pre class="code puppet"><code class="puppet">  class { &#39;sensu::plugins&#39;:
    dependencies =&gt; [],
  }
</code></pre>

<p>If gems are required and not pulled in as gem dependencies they can also be installed.</p>

<pre class="code puppet"><code class="puppet">class { &#39;sensu::plugins&#39;:
  plugins          =&gt; [&#39;memory-checks&#39;],
  gem_dependencies =&gt; [&#39;vmstat&#39;],
}
</code></pre>

<p>You can uninstall plugins by passing <code>ensure</code> as <code>absent</code>.</p>

<pre class="code puppet"><code class="puppet">  class { &#39;sensu::agent&#39;:
    backends      =&gt; [&#39;sensu-backend.example.com:8081&#39;],
    subscriptions =&gt; [&#39;linux&#39;, &#39;apache-servers&#39;],
  }
  class { &#39;sensu::plugins&#39;:
    plugins =&gt; {
      &#39;disk-checks&#39; =&gt; { &#39;ensure&#39; =&gt; &#39;absent&#39; },
    },
  }
</code></pre>

<h3 id="installing-extensions">Installing Extensions</h3>

<p>Extension management is handled by the <code>sensu::plugins</code> class.</p>

<p>Example installing extension on backend:</p>

<pre class="code puppet"><code class="puppet">  class { &#39;sensu&#39;:
    password =&gt; &#39;supersecret&#39;,
  }
  include sensu::backend
  class { &#39;sensu::plugins&#39;:
    extensions =&gt; [&#39;graphite&#39;],
  }
</code></pre>

<p>The <code>extensions</code> parameter can also be a Hash that sets the version:</p>

<pre class="code puppet"><code class="puppet">  class { &#39;sensu&#39;:
    password =&gt; &#39;supersecret&#39;,
  }
  include sensu::backend
  class { &#39;sensu::plugins&#39;:
    extensions =&gt; {
      &#39;graphite&#39; =&gt; { &#39;version&#39; =&gt; &#39;latest&#39; },
    },
  }
</code></pre>

<p>You can uninstall extensions by passing <code>ensure</code> as <code>absent</code>.</p>

<pre class="code puppet"><code class="puppet">  class { &#39;sensu&#39;:
    password =&gt; &#39;supersecret&#39;,
  }
  include sensu::backend
  class { &#39;sensu::plugins&#39;:
    extensions =&gt; {
      &#39;graphite&#39; =&gt; { &#39;ensure&#39; =&gt; &#39;absent&#39; },
    },
  }
</code></pre>

<h3 id="exported-resources">Exported resources</h3>

<p>One possible approach to defining checks is having agents export their checks to the sensu-backend using <a href="https://puppet.com/docs/puppet/latest/lang_exported.html">Exported Resources</a>.</p>

<p>The following example would be defined for agents:</p>

<pre class="code puppet"><code class="puppet">  @@sensu_check { &#39;check-cpu&#39;:
    ensure        =&gt; &#39;present&#39;,
    command       =&gt; &#39;check-cpu.sh -w 75 -c 90&#39;,
    interval      =&gt; 60,
    subscriptions =&gt; [&#39;linux&#39;],
  }
</code></pre>

<p>The backend system would collect all <code>sensu_check</code> resources.</p>

<pre class="code puppet"><code class="puppet">  Sensu_check &lt;&lt;||&gt;&gt;
</code></pre>

<h3 id="hiera-resources">Hiera resources</h3>

<p>All the types provided by this module can have their resources defined via Hiera. A type such as <code>sensu_check</code> would be defined via <code>sensu::resources::checks</code>.</p>

<p>The <code>sensu</code> class must be included either directly or via <code>sensu::agent</code> or <code>sensu::backend</code>.</p>

<p>The following example adds an asset, filter, handler and checks via Hiera:</p>

<pre class="code yaml"><code class="yaml">sensu::resources::assets:
  sensu-email-handler:
    ensure: present
    url: &#39;https://github.com/sensu/sensu-email-handler/releases/download/0.1.0/sensu-email-handler_0.1.0_linux_amd64.tar.gz&#39;
    sha512: &#39;755c7a673d94997ab9613ec5969666e808f8b4a8eec1ba998ee7071606c96946ca2947de5189b24ac34a962713d156619453ff7ea43c95dae62bf0fcbe766f2e&#39;
    filters:
      - &quot;entity.system.os == &#39;linux&#39;&quot;
      - &quot;entity.system.arch == &#39;amd64&#39;&quot;
sensu::resources::filters:
  hourly:
    ensure: present
    action: allow
    expressions:
      - &#39;event.check.occurrences == 1 || event.check.occurrences % (3600 / event.check.interval) == 0&#39;
sensu::resources::handlers:
  email:
    ensure: present
    type: pipe
    command: &quot;sensu-email-handler -f root@localhost -t user@example.com -s localhost -i&quot;
    timeout: 10
    runtime_assets:
      - sensu-email-handler
    filters:
      - is_incident
      - not_silenced
      - hourly
sensu::resources::checks:
  check-cpu:
    ensure: present
    command: check-cpu.sh -w 75 -c 90
    interval: 60
    subscriptions:
      - linux
    handlers:
      - email
    publish: true
  check-disks:
    ensure: present
    command: &quot;/opt/sensu-plugins-ruby/embedded/bin/check-disk-usage.rb -t &#39;(xfs|ext4)&#39;&quot;
    subscriptions:
      - linux
    handlers:
      - email
    interval: 1800
    publish: true
</code></pre>

<h3 id="resource-purging">Resource purging</h3>

<p>All the types provided by this module support purging except <code>sensu_config</code>.
This example will remove all unmanaged Sensu checks:</p>

<pre class="code puppet"><code class="puppet">sensu_resources { &#39;sensu_check&#39;:
  purge =&gt; true,
}
</code></pre>

<p>To selectively purge <code>sensu_agent_entity_config</code> entries, you can specify the type of config to purge.
If <code>agent_entity_configs</code> is omitted then all unmanaged <code>sensu_agent_entity_config</code> resources will be purged.
The following example will only purge subscriptions:</p>

<pre class="code puppet"><code class="puppet">sensu_resources { &#39;sensu_agent_entity_config&#39;:
  purge                =&gt; true,
  agent_entity_configs =&gt; [&#39;subscriptions&#39;],
}
</code></pre>

<p><strong>NOTE</strong>: The Puppet built-in <code>resources</code> can also be used for purging but you must ensure that resources that support namespaces are defined using composite names in the form of <code>$name in $namespace</code>. See <a href="#composite-names-for-namespaces">Composite Names for Namespaces</a> for details on composite names.</p>

<p>Using the Puppet built-in <code>resources</code> would look like this:</p>

<pre class="code puppet"><code class="puppet">resources { &#39;sensu_check&#39;:
  purge =&gt; true,
}
</code></pre>

<h3 id="sensu-backend-cluster">Sensu backend cluster</h3>

<p>A <code>sensu-backend</code> cluster can be defined for fresh installs by defining the necessary <code>config_hash</code> values.
The following examples are using Hiera and assume the <code>sensu::backend</code> class is included.</p>

<pre class="code yaml"><code class="yaml"># data/fqdn/sensu-backend1.example.com.yaml
---
sensu::backend::config_hash:
  etcd-advertise-client-urls: &quot;http://%{facts.ipaddress}:2379&quot;
  etcd-listen-client-urls: &quot;http://%{facts.ipaddress}:2379&quot;
  etcd-listen-peer-urls: &#39;http://0.0.0.0:2380&#39;
  etcd-initial-cluster: &#39;backend1=http://192.168.0.1:2380,backend2=http://192.168.0.2:2380&#39;
  etcd-initial-advertise-peer-urls: &quot;http://%{facts.ipaddress}:2380&quot;
  etcd-initial-cluster-state: &#39;new&#39;
  etcd-initial-cluster-token: &#39;&#39;
  etcd-name: &#39;backend1&#39;
</code></pre>

<pre class="code yaml"><code class="yaml"># data/fqdn/sensu-backend2.example.com.yaml
---
sensu::backend::config_hash:
  etcd-advertise-client-urls: &quot;http://%{facts.ipaddress}:2379&quot;
  etcd-listen-client-urls: &quot;http://%{facts.ipaddress}:2379&quot;
  etcd-listen-peer-urls: &#39;http://0.0.0.0:2380&#39;
  etcd-initial-cluster: &#39;backend1=http://192.168.0.1:2380,backend2=http://192.168.0.2:2380&#39;
  etcd-initial-advertise-peer-urls: &quot;http://%{facts.ipaddress}:2380&quot;
  etcd-initial-cluster-state: &#39;new&#39;
  etcd-initial-cluster-token: &#39;&#39;
  etcd-name: &#39;backend2&#39;
</code></pre>

<h4 id="adding-backend-members-to-an-existing-cluster">Adding backend members to an existing cluster</h4>

<p>Adding new members to an existing cluster requires two steps.</p>

<p>First, add the member to the catalog on one of the existing cluster backends with the <code>sensu_cluster_member</code> type.</p>

<pre class="code puppet"><code class="puppet">sensu_cluster_member { &#39;backend3&#39;:
  peer_urls =&gt; [&#39;http://192.168.0.3:2380&#39;],
}
</code></pre>

<p>Second, configure and start <code>sensu-backend</code> to interact with the existing cluster.
The output from Puppet when a new <code>sensu_cluster_member</code> is applied will print some of the values needed.</p>

<pre class="code yaml"><code class="yaml"># data/fqdn/sensu-backend3.example.com.yaml
---
sensu::backend::config_hash:
  etcd-advertise-client-urls: &quot;http://%{facts.ipaddress}:2379&quot;
  etcd-listen-client-urls: &quot;http://%{facts.ipaddress}:2379&quot;
  etcd-listen-peer-urls: &#39;http://0.0.0.0:2380&#39;
  etcd-initial-cluster: &#39;backend1=http://192.168.0.1:2380,backend2=http://192.168.0.2:2380,backend3=http://192.168.0.3:2380&#39;
  etcd-initial-advertise-peer-urls: &quot;http://%{facts.ipaddress}:2380&quot;
  etcd-initial-cluster-state: &#39;existing&#39;
  etcd-initial-cluster-token: &#39;&#39;
  etcd-name: &#39;backend3&#39;
</code></pre>

<p>The first step will not fully add the node to the cluster until the second step is performed.</p>

<h3 id="sensu-backend-federation">Sensu backend federation</h3>

<p>This module supports defining Etcd replicators which allows resources to be sent from one Sensu cluster to another cluster.
It is necessary that Etcd be listening on an interface that can be accessed by other Sensu backends.
First configure backend Etcd to listen on an interface besides localhost and also use SSL:</p>

<pre class="code puppet"><code class="puppet">class { &#39;sensu::backend&#39;:
  config_hash =&gt; {
    &#39;etcd-listen-client-urls&#39;    =&gt; &quot;https://0.0.0.0:2379&quot;,
    &#39;etcd-advertise-client-urls&#39; =&gt; &quot;https://0.0.0.0:2379&quot;,
    &#39;etcd-cert-file&#39;             =&gt; &quot;/etc/sensu/etcd-ssl/${facts[&#39;fqdn&#39;].pem&quot;,
    &#39;etcd-key-file&#39;              =&gt; &quot;/etc/sensu/etcd-ssl/${facts[&#39;fqdn&#39;]}-key.pem&quot;,
    &#39;etcd-trusted-ca-file&#39;       =&gt; &quot;/etc/sensu/etcd-ssl/ca.pem&quot;,
    &#39;etcd-client-cert-auth&#39;      =&gt; true,
  },
}
</code></pre>

<p>Next configure the Etcd replicator on the backend you wish to push resources from.
In the following example all defined <code>Role</code> resources will be replicated to the backend at the IP address 192.168.52.30.</p>

<pre class="code puppet"><code class="puppet">sensu_etcd_replicator { &#39;role_replicator&#39;:
  ensure        =&gt; &#39;present&#39;,
  ca_cert       =&gt; &#39;/etc/sensu/etcd-ssl/ca.pem&#39;,
  cert          =&gt; &#39;/etc/sensu/etcd-ssl/client.pem&#39;,
  key           =&gt; &#39;/etc/sensu/etcd-ssl/client-key.pem&#39;,
  url           =&gt; &#39;https://192.168.52.30:2379&#39;,
  resource_name =&gt; &#39;Role&#39;,
}
sensu_role { &#39;test&#39;:
  ensure =&gt; &#39;present&#39;,
  rules  =&gt; [{&#39;verbs&#39; =&gt; [&#39;get&#39;,&#39;list&#39;], &#39;resources&#39; =&gt; [&#39;checks&#39;], &#39;resource_names&#39; =&gt; [&#39;&#39;]}],
}
</code></pre>

<p>This module also supports defining a federated cluster:</p>

<pre class="code puppet"><code class="puppet">sensu_cluster_federation { &#39;us-west-2a&#39;:
  ensure   =&gt; &#39;present&#39;,
  api_urls =&gt; [
    &#39;https://sensu-backend-site1.example.com:8080&#39;,
    &#39;https://sensu-backend-site2.example.com:8080&#39;,
  ],
}
</code></pre>

<p>It is also possible to add a backend to an existing Sensu federated cluster.
The following example adds the API URL <a href="https://sensu-backend-site3.example.com:8080">https://sensu-backend-site3.example.com:8080</a> to the federated cluster named us-west-2a.</p>

<pre class="code puppet"><code class="puppet">sensu_cluster_federation_member { &#39;https://sensu-backend-site3.example.com:8080 in us-west-2a&#39;:
  ensure =&gt; &#39;present&#39;,
}
</code></pre>

<p>The above can also be defined using the following example:</p>

<pre class="code puppet"><code class="puppet">sensu_cluster_federation_member { &#39;https://sensu-backend-site3.example.com:8080&#39;:
  ensure  =&gt; &#39;present&#39;,
  cluster =&gt; &#39;us-west-2a&#39;,
}
</code></pre>

<h3 id="large-environment-considerations">Large Environment Considerations</h3>

<p>If the backend system has a large number of resources it may be necessary to query resources using chunk size added in Sensu Go 5.8.</p>

<pre class="code ruby"><code class="ruby">class { &#39;sensu::backend&#39;:
  sensuctl_chunk_size =&gt; 100,
}
</code></pre>

<p>If many thousands of resources such as <code>sensu_check</code> are defined there will be an execution of <code>sensuctl namespace list</code> for each check to validate
the namespace exists if the namespace is not defined in Puppet.
A similar validation is performed with <code>sensu_api</code> provider.  To avoid this extra overhead it may be necessary to disable this validation if you
are defining namespaces outside of Puppet.</p>

<p><strong>NOTE</strong>: If namespace validation is disabled it&#39;s necessary to ensure a namespace is defined in Puppet in order to assign resources to that namespace.</p>

<pre class="code puppet"><code class="puppet">class { &#39;sensu&#39;:
  validate_namespaces =&gt; false,
}
</code></pre>

<h3 id="composite-names-for-namespaces">Composite Names for Namespaces</h3>

<p>All resources that support having a <code>namespace</code> also support a composite name to define the namespace.</p>

<p>For example, the <code>sensu_check</code> with name <code>check-cpu in team1</code> would be named <code>check-cpu</code> and put into the <code>team1</code> namespace.</p>

<p>Using composite names is necessary if you wish to have multiple resources with the same name but in different namespaces.</p>

<p>For example to define the same check in two namespaces using the same check name:</p>

<pre class="code puppet"><code class="puppet">sensu_check { &#39;check-cpu in default&#39;:
  ensure        =&gt; &#39;present&#39;,
  command       =&gt; &#39;check-cpu.sh -w 75 -c 90&#39;,
  interval      =&gt; 60,
  subscriptions =&gt; [&#39;linux&#39;],
}
sensu_check { &#39;check-cpu in team1&#39;:
  ensure        =&gt; &#39;present&#39;,
  command       =&gt; &#39;check-cpu.sh -w 75 -c 90&#39;,
  interval      =&gt; 60,
  subscriptions =&gt; [&#39;linux&#39;],
}
</code></pre>

<p>The example above would add the <code>check-cpu</code> check to both the <code>default</code> and <code>team1</code> namespaces.</p>

<p><strong>NOTE:</strong> If you use composite names for namespaces, the <code>namespace</code> property takes precedence.</p>

<h3 id="installing-bonsai-assets">Installing Bonsai Assets</h3>

<p>Install a bonsai asset. The latest version will be installed but not automatically upgraded.</p>

<pre class="code puppet"><code class="puppet">sensu_bonsai_asset { &#39;sensu/sensu-pagerduty-handler&#39;:
  ensure  =&gt; &#39;present&#39;,
}
</code></pre>

<p>Install specific version of a bonsai asset.</p>

<pre class="code puppet"><code class="puppet">sensu_bonsai_asset { &#39;sensu/sensu-pagerduty-handler&#39;:
  ensure  =&gt; &#39;present&#39;,
  version =&gt; &#39;1.2.0&#39;,
}
</code></pre>

<p>Install latest version of a bonsai asset. Puppet will update the Bonsai asset if a new version is released.</p>

<pre class="code puppet"><code class="puppet">sensu_bonsai_asset { &#39;sensu/sensu-pagerduty-handler&#39;:
  ensure  =&gt; &#39;present&#39;,
  version =&gt; &#39;latest&#39;,
}
</code></pre>

<h3 id="bolt-tasks">Bolt Tasks</h3>

<p>The following Bolt tasks are provided by this Module:</p>

<p><strong>sensu::backend_upgrade</strong>: Perform backend upgrade via <code>sensu-backend upgrade</code> command.</p>

<p>Example: <code>bolt task run sensu::backend_upgrade --targets sensu_backend</code></p>

<p><strong>sensu::agent_event</strong>: Create a Sensu Go agent event via the agent API</p>

<p>Example: <code>bolt task run sensu::agent_event name=bolttest status=1 output=test --targets sensu_agent</code></p>

<p><strong>sensu::apikey</strong>: Manage Sensu Go API keys</p>

<p>Example: <code>bolt task run sensu::apikey action=create username=foobar --targets sensu_backend</code>
Example: <code>bolt task run sensu::apikey action=list --targets sensu_backend</code>
Example: <code>bolt task run sensu::apikey action=delete key=replace-with-uuid-key --targets sensu_backend</code></p>

<p><strong>sensu::assets_outdated</strong>: Retreive outdated Sensu Go assets</p>

<p>Example: <code>bolt task run sensu::assets_outdated --targets sensu_backend</code></p>

<p><strong>sensu::check_execute</strong>: Execute a Sensu Go check</p>

<p>Example: <code>bolt task run sensu::check_execute check=test subscription=entity:sensu_agent --targets sensu_backend</code></p>

<p><strong>sensu::event.json</strong>: Manage Sensu Go events</p>

<p>Example: <code>bolt task run sensu::event action=resolve entity=sensu_agent check=test --targets sensu_backend</code></p>

<p>Example: <code>bolt task run sensu::event action=delete entity=sensu_agent check=test --targets sensu_backend</code></p>

<p><strong>sensu::silenced</strong>: Manage Sensu Go silencings</p>

<p>Example: <code>bolt task run sensu::silenced action=create subscription=entity:sensu_agent expire_on_resolve=true --targets sensu_backend</code></p>

<p>Example: <code>bolt task run sensu::silenced action=delete subscription=entity:sensu_agent --targets sensu_backend</code></p>

<p><strong>sensu::install_agent</strong>: Install Sensu Go agent (Windows and Linux)</p>

<p>Example: <code>bolt task run sensu::install_agent backend=sensu_backend:8081 subscription=linux output=true --targets linux</code></p>

<p>Example: <code>bolt task run sensu::install_agent backend=sensu_backend:8081 subscription=windows output=true --targets windows</code></p>

<h3 id="bolt-inventory">Bolt Inventory</h3>

<p>This module provides a plugin to populate Bolt v2 inventory targets.</p>

<p>In order to use the <code>sensu</code> inventory plugin the host executing Bolt must have <code>sensuctl</code> configured, see <a href="#basic-sensu-cli">Basic Sensu CLI</a>.</p>

<p>Example of configuring the Bolt inventory with two groups. The <code>linux</code> group pulls Sensu Go entities in the <code>default</code> namespace with the <code>linux</code> subscription. The <code>linux-qa</code> group is the same as <code>linux</code> group but instead pulling entities from the <code>qa</code> namespace.</p>

<pre class="code yaml"><code class="yaml">version: 2
groups:
  - name: linux
    targets:
      - _plugin: sensu
        namespace: default
        subscription: linux
  - name: linux-qa
    targets:
      - _plugin: sensu
        namespace: qa
        subscription: linux
</code></pre>

<p>If your entities have more than one network interface it may be necessary to specify the order of interfaces to search when looking for the IP address:</p>

<pre class="code yaml"><code class="yaml">version: 2
groups:
  - name: linux
    targets:
      - _plugin: sensu
        namespace: default
        subscription: linux
        interface_list:
          - eth0
          - eth1
</code></pre>

<p>The following rules for interface matching determine the value used for <code>uri</code>.</p>

<ol>
<li>If <code>interface_list</code> was defined then find first match</li>
<li>If <code>interface_list</code> not defined and only one interface, use that as ipaddress</li>
<li>If <code>interface_list</code> is not defined and more than one interface, use name</li>
</ol>

<h2 id="reference">Reference</h2>

<h3 id="facts">Facts</h3>

<h4 id="sensu_agent"><code>sensu_agent</code></h4>

<p>The <code>sensu_agent</code> fact returns the Sensu agent version information by the <code>sensu-agent</code> binary.</p>

<pre class="code shell"><code class="shell">facter -p sensu_agent
{
  version =&gt; &quot;5.1.0&quot;,
  build =&gt; &quot;b2ea9fcdb21e236e6e9a7de12225a6d90c786c57&quot;,
  built =&gt; &quot;2018-12-18T21:31:11+0000&quot;
}
</code></pre>

<h4 id="sensu_backend"><code>sensu_backend</code></h4>

<p>The <code>sensu_backend</code> fact returns the Sensu backend version information by the <code>sensu-backend</code> binary.</p>

<pre class="code shell"><code class="shell">facter -p sensu_backend
{
  version =&gt; &quot;5.1.0&quot;,
  build =&gt; &quot;b2ea9fcdb21e236e6e9a7de12225a6d90c786c57&quot;,
  built =&gt; &quot;2018-12-18T21:31:11+0000&quot;
}
</code></pre>

<h4 id="sensuctl"><code>sensuctl</code></h4>

<p>The <code>sensuctl</code> fact returns the sensuctl version information by the <code>sensuctl</code> binary.</p>

<pre class="code shell"><code class="shell">facter -p sensuctl
{
  version =&gt; &quot;5.1.0&quot;,
  build =&gt; &quot;b2ea9fcdb21e236e6e9a7de12225a6d90c786c57&quot;,
  built =&gt; &quot;2018-12-18T21:31:11+0000&quot;
}
</code></pre>

<h2 id="examples">Examples</h2>

<p>Examples can be found in the <a href="https://github.com/sensu/sensu-puppet/tree/master/examples">examples</a> directory.</p>

<ul>
<li><a href="https://github.com/sensu/sensu-puppet/blob/master/examples/contact_routing.pp">Contact Routing</a> - Example of contact routing</li>
<li><a href="https://github.com/sensu/sensu-puppet/blob/master/examples/email_alerts.pp">Email Alerts</a> - Example of setting up e-mail alerts</li>
<li><a href="https://github.com/sensu/sensu-puppet/blob/master/examples/influxdb_handler.pp">InfluxDB Handler</a> - Example of setting up InfluxDB handler</li>
<li><a href="https://github.com/sensu/sensu-puppet/blob/master/examples/ldap.pp">LDAP</a> - Example of setting up LDAP authentication</li>
<li><a href="https://github.com/sensu/sensu-puppet/blob/master/examples/logging.pp">Logging</a> - Example of setting up improved logging</li>
<li><a href="https://github.com/sensu/sensu-puppet/blob/master/examples/pagerduty-with-secrets-env.pp">Pagerduty with Secrets Env Vars</a> - Setting up Pagerduty using environment variable secrets</li>
<li><a href="https://github.com/sensu/sensu-puppet/blob/master/examples/pagerduty-with-secrets-vault.pp">Pagerduty with Secrets vault</a> - Setting up Pagerduty using secrets vault</li>
<li><a href="https://github.com/sensu/sensu-puppet/tree/master/examples/postgresql-replication">PostgreSQL with Replication</a> - Contains example manifests of setting up Sensu backend and PostgreSQL with PostgreSQL replication.</li>
<li><a href="https://github.com/sensu/sensu-puppet/tree/master/examples/postgresql-ssl">PostgreSQL with SSL</a> - Contains example manifests of setting up Sensu backend and PostgreSQL to communicate using SSL.</li>
<li><a href="https://github.com/sensu/sensu-puppet/blob/master/examples/slack_alerts.pp">Slack Alerts</a> - Example of setting up Slack alerts</li>
</ul>

<h2 id="limitations">Limitations</h2>

<p>Changing <code>sensu::etc_dir</code> is only supported on systems using systemd.</p>

<p>The type <code>sensu_user</code> does not at this time support <code>ensure =&gt; absent</code> due to a limitation with sensuctl, see <a href="https://github.com/sensu/sensu-go/issues/2540">sensu-go#2540</a>.</p>

<p>When changing the <code>sensu::password</code> value, it&#39;s necessary to run Puppet on the backend first to update the <code>admin</code> password.</p>

<h3 id="notes-regarding-support">Notes regarding support</h3>

<p>This module is built for use with Puppet versions 6 and 7 and the ruby
versions associated with those releases. See <code>.travis.yml</code> for an exact
matrix of Puppet releases and ruby versions.</p>

<p>This module targets the latest release of the current major Puppet
version and the previous major version. Platform support will be removed
when a platform is no longer supported by Puppet, Sensu or the platform
maintainer has signaled that it is end of life (EOL).</p>

<p>Though Amazon does not announce end of life (EOL) for its releases, it
does encourage you to use the latest releases. This module will support
the current release and the previous release. Since AWS does not release
Vagrant boxes and the intent of those platforms is to run in AWS, we
will not maintain Vagrant systems for local development for Amazon
Linux.</p>

<h3 id="supported-platforms">Supported Platforms</h3>

<ul>
<li>EL 6</li>
<li>EL 7</li>
<li>EL 8</li>
<li>Debian 9</li>
<li>Debian 10</li>
<li>Ubuntu 16.04 LTS</li>
<li>Ubuntu 18.04 LTS</li>
<li>Ubuntu 20.04 LTS</li>
<li>Amazon 2018.03</li>
<li>Amazon 2</li>
<li>Windows Server 2008 R2</li>
<li>Windows Server 2012 R2</li>
<li>Windows Server 2016</li>
<li>Windows Server 2019</li>
</ul>

<h2 id="development">Development</h2>

<p>See <a href="CONTRIBUTING.md">CONTRIBUTING.md</a></p>

<h2 id="license">License</h2>

<p>See <a href="LICENSE">LICENSE</a> file.</p>
</div></div>

      <div id="footer">
     Generated by <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>.
</div>

    </div>
  </body>
</html>